#!/usr/bin/env ruby
require "fileutils"

APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args, exception: true)
end

def check_docker
  unless system("docker --version > /dev/null 2>&1")
    abort "❌ Docker is not installed. Please install Docker Desktop first."
  end
  
  unless system("docker-compose --version > /dev/null 2>&1")
    abort "❌ Docker Compose is not installed. Please install Docker Compose first."
  end
end

FileUtils.chdir APP_ROOT do
  puts "🐳 Setting up Speedrail with Docker..."
  
  check_docker
  
  puts "\n📦 Building Docker images..."
  system! "docker-compose build"
  
  puts "\n🗄️  Setting up database..."
  system! "docker-compose run --rm web bundle exec rails db:create db:migrate db:seed"
  
  puts "\n✅ Setup complete!"
  puts "\n🚀 To start the application:"
  puts "   docker-compose up"
  puts "\n🌐 Application will be available at: http://localhost:3000"
  puts "\n📊 Admin panel: http://localhost:3000/admin"
  puts "\n🛑 To stop: docker-compose down"
end
